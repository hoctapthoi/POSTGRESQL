############# percona postgres 16.9 ######
# download package https://docs.percona.com/postgresql/16/tarball.html
# https://downloads.percona.com/downloads/postgresql-distribution-16/16.9/binary/tarball/percona-postgresql-16.9-ssl1.1-linux-x86_64.tar.gz
# pre-install
mount /dev/cdrom /mnt
cd /etc/yum.repos.d/
mkdir bak
mv *.repo bak

sudo tee /etc/yum.repos.d/local.repo > /dev/null <<'EOF'
[local1]
enabled=1
gpgcheck=0
baseurl=file:///mnt/BaseOS

[local2]
enabled=1
gpgcheck=0
baseurl=file:///mnt/AppStream
EOF

systemctl stop firewalld
systemctl disable firewalld

setenforce 0
sudo sed -i 's/^SELINUX=.*/SELINUX=permissive/' /etc/selinux/config

yum install -y readline-devel zlib-devel gcc make libicu libicu-devel rsync bash-completion net-tools unzip tar

mkdir -p /u01/app/16
mkdir -p /u02/pgsql/data
mkdir -p /u02/pgsql/logs
useradd -d /home/postgres/ postgres
usermod -aG wheel postgres


tar -xvf percona-postgresql-16.9-ssl1.1-linux-x86_64.tar.gz
cd percona-postgresql-16.9-ssl1.1-linux-x86_64
mv percona-python3/ percona-tcl/ percona-perl/ /u01/app
mv * /u01/app/16
chown postgres:postgres -R /u01 /u02
su - postgres
export PATH=/u01/app/16/percona-haproxy/sbin:/u01/app/16/percona-patroni/bin:/u01/app/16/percona-pgbackrest/bin:/u01/app/16/percona-pgbadger/:/u01/app/16/percona-pgbouncer/bin:/u01/app/16/percona-pgpool-II/bin:/u01/app/16/percona-postgresql16/bin:/u01/app/16/percona-etcd/bin:$PATH
export PATH=/u01/app/percona-perl/bin:/u01/app/percona-tcl/bin:/u01/app/percona-python3/bin:$PATH
export PGDATA=/u02/pgsql/data
passwd postgres
id postgres

initdb -D /u02/pgsql/data
pg_ctl -D /u02/pgsql/data -l /u02/pgsql/logs/postgresql-16-main.log start
sudo vi /etc/systemd/system/postgresql.service

[Unit]
Description=PostgreSQL database server
After=network.target

[Service]
Type=forking
User=postgres
Group=postgres

# Start command
ExecStart=/u01/app/16/percona-postgresql16/bin/pg_ctl -l /u02/pgsql/logs/postgresql-16-main.log -D /u02/pgsql/data start

# Stop command
ExecStop=/u01/app/16/percona-postgresql16/bin/pg_ctl stop -D /u02/pgsql/data -m fast

# Restart command
ExecReload=/u01/app/16/percona-postgresql16/bin/pg_ctl reload -D /u02/pgsql/data

# Environment
Environment=PGDATA=/u01/app/16/data

# Restart policy
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target

