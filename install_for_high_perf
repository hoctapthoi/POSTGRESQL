======= 1, architect=======
binary, archive file: normal disk
data file : normal/ssd disk
wal, temp files: ssd disk

======== 2, binary install Postgres
# download link: https://www.postgresql.org/ftp/source/v16.10/

# pre-install
mount /dev/cdrom /mnt
cd /etc/yum.repos.d/
mkdir bak
mv *.repo bak

sudo tee /etc/yum.repos.d/local.repo > /dev/null <<'EOF'
[local1]
enabled=1
gpgcheck=0
baseurl=file:///mnt/BaseOS

[local2]
enabled=1
gpgcheck=0
baseurl=file:///mnt/AppStream
EOF

systemctl stop firewalld
systemctl disable firewalld

setenforce 0
sudo sed -i 's/^SELINUX=.*/SELINUX=permissive/' /etc/selinux/config

yum install -y readline-devel zlib-devel gcc make libicu libicu-devel rsync bash-completion net-tools unzip

useradd -d /home/postgres/ postgres
usermod -aG wheel postgres
mkdir -p /u01/app/16/init
mkdir -p /u01/app/16/data
mkdir -p /u01/app/16/wal_files
mkdir -p /u01/app/16/archive_logs
mkdir -p /u01/app/16/temp_files
mkdir -p /var/run/postgresql
chown postgres:postgres -R /u01 /var/run/postgresql

passwd postgres
id postgres

======== 3, build, install PostgreSQL
tar -xvf postgresql-16.6.tar.gz
cd postgresql-16.6
./configure --prefix=/u01/app/16/init

make
make install

======== 4, build, install contrib module
cd contrib
make
make install

======== 5, check configure
cd /u01/app/16/init/bin
./pg_config

========= 6, change owner, export PATH
chown postgres:postgres -R /u01
export PATH=/u01/app/16/init/bin:$PATH
export PGDATA=/u01/app/16/data
initdb

========= 7, create postgresql service
sudo vi /etc/systemd/system/postgresql.service
[Unit]
Description=PostgreSQL database server
After=network.target

[Service]
Type=forking
User=postgres
Group=postgres

# Start command
ExecStart=/u01/app/16/init/bin/pg_ctl start -l /u01/app/16/postgresql-16-main.log -D /u01/app/16/data

# Stop command
ExecStop=/u01/app/16/init/bin/pg_ctl stop -D /u01/app/16/data -m fast

# Restart command
ExecReload=/u01/app/16/init/bin/pg_ctl reload -D /u01/app/16/data

# Environment
Environment=PGDATA=/u01/app/16/data

# Restart policy
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target


sudo systemctl daemon-reexec
sudo systemctl daemon-reload
sudo systemctl enable postgresql
sudo systemctl start postgresql


======= 7, change wal_files from default directory to new location
 rsync -av /u01/app/16/data/pg_wal/* /u01/app/16/wal_files
 mv /u01/app/16/data/pg_wal /u01/app/16/data/pg_wal-backup
 sudo ln -s /u01/app/16/wal_files/  /u01/app/16/data/pg_wal
